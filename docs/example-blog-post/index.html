<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, minimum-scale=1">
    <link rel="stylesheet" href="stylesheet.css">
    <title>A blog post</title>
  </head>
  <body>
    <h1></h1>
    <span id="allViews">All Views: <span class="fas fa-spinner fa-spin"></span> LOADING</span>
    <span id="uniqueViews">Unique Views: <span class="fas fa-spinner fa-spin"></span> LOADING</span>
    <span id="botViews">Bot Views: <span class="fas fa-spinner fa-spin"></span> LOADING</span>
    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec vitae augue augue. Etiam nibh turpis, egestas eu diam nec, hendrerit fermentum est. Nullam sodales velit urna, a ornare magna sagittis at. Cras at augue at ante varius iaculis mollis eget quam. Sed id metus orci. Phasellus porta scelerisque leo, at tristique est mollis non. Mauris imperdiet augue eu eros suscipit tincidunt ut sit amet tortor. Ut imperdiet dui sit amet leo fringilla egestas. Vestibulum eleifend euismod mauris nec scelerisque. Vivamus aliquet tortor nisi, eget maximus sem sagittis sit amet. Nullam pretium eget mi sed semper. In quis ipsum vitae neque vehicula vehicula. Nulla a imperdiet urna. Aliquam rutrum semper sapien, eu maximus metus scelerisque eget. Phasellus pharetra ornare lacus, ac ornare velit ultricies a.</p>
    <h2>Comments</h2>
    <div id="comments"><span class="fas fa-spinner fa-spin"></span> LOADING</div>

    <form>
      <label for="name">Name:</label>
      <input id="name" type="text">
      <label for="comment">Comment:</label>
      <input id="comment" type="text">
      <button id="submitComment" type="button">Submit</button>
    </form>

    <script src="https://kit.fontawesome.com/617f7aefb4.js" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://npmcdn.com/parse/dist/parse.min.js"></script>
    <script type="text/javascript">
      function escapeHTML(html) {
        return html.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
      }

      function incrementViews(types) {
        Parse.Cloud.run('incrementViews', {
          name: document.title,
          types
        }).then((res) => {
          getViewsAndComments();
        });
      }

      function getViewsAndComments() {
        Parse.Cloud.run('getViewsAndComments', {
          name: document.title
        }).then((res) => {
          document.getElementById('allViews').innerText = `All Views: ${ res.allViews }`;
          document.getElementById('uniqueViews').innerText = `Unique Views: ${ res.uniqueViews }`;
          document.getElementById('botViews').innerText = `Bot Views: ${ res.botViews }`;
          document.getElementById('comments').innerHTML = res.comments.reverse().reduce((acc, value) => {
            return acc + `
              <div class="comment">
                <b>${ value.name }</b>
                <p>${ value.comment }</p>
              </div>
            `;
          }, '');
        });
      }

      document.getElementsByTagName('h1')[0].innerText = document.title;

      Parse.initialize("55LsP3jDMhMzJ5k9J3wqpZ8ebMUrGkcgaj17Pfgz","AjXQYFg6wIhUMunRYpGvoRdNsliOZxRYMFG6FsX7"); //PASTE HERE YOUR Back4App APPLICATION ID AND YOUR JavaScript KEY
      Parse.serverURL = 'https://parseapi.back4app.com/'
      
      if (/bot|crawl|spider/i.test(navigator.userAgent)) {
        incrementViews(['all', 'bot']);
      } else if (localStorage.getItem(document.title + 'viewed')) {
        incrementViews(['all']);
      } else {
        localStorage.setItem(document.title + 'viewed', true);
        incrementViews(['all', 'unique']);
      }

      document.getElementById('submitComment').addEventListener('click', () => {
        const username = document.getElementById('name').value;
        const comment = escapeHTML(document.getElementById('comment').value);

        Parse.Cloud.run('addComment', {
          name: document.title,
          username,
          comment
        }).then((res) => {
          document.getElementById('comments').innerHTML = `
            <div class="comment">
              <b>${ username }</b>
              <p>${ comment }</p>
            </div>
          ` + document.getElementById('comments').innerHTML;
        });
      });
    </script>
  </body>
</html>
