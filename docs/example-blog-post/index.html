<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, minimum-scale=1">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap">
    <link rel="stylesheet" href="stylesheet.css">
    <title>A Blog Post</title>
  </head>
  <body>
    <h1><script> document.write(document.title); </script></h1>
    <span id="allViews">All Views: <span class="fas fa-spinner fa-spin"></span></span>
    <span id="uniqueViews">Unique Views: <span class="fas fa-spinner fa-spin"></span></span>
    <span id="botViews">Bot Views: <span class="fas fa-spinner fa-spin"></span></span>
    <p id="body">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Quisque nec est hendrerit, gravida erat vitae, eleifend odio. Praesent cursus pharetra velit et congue. Vestibulum semper semper nisl, ac porta magna commodo nec. Donec non nisl nulla. Nunc sit amet est vitae est lacinia fermentum non in nunc. Praesent rutrum tempus nunc, rhoncus condimentum justo blandit sit amet. Nam nec varius ante. Phasellus sit amet turpis ut orci dapibus luctus. Nullam ac leo quis erat mattis efficitur iaculis eget sapien. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos.

      Proin feugiat libero posuere, lacinia arcu non, bibendum erat. Quisque mollis at tellus at venenatis. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia curae; Nunc rutrum ante in aliquet semper. Curabitur ac velit sed odio tempor suscipit. Nullam gravida eros vel massa egestas, vel tincidunt nibh iaculis. Nam orci mauris, mattis efficitur tempor ut, iaculis et odio. Ut at nunc ut purus porta luctus eget ac mi.
      
      Duis at risus euismod felis convallis molestie sed sit amet eros. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nam eget odio sed sapien viverra imperdiet. Nunc blandit eget mi eget ultricies. Integer varius dignissim posuere. Aenean non congue nisi. Phasellus finibus metus eleifend purus fringilla pellentesque.
      
      Proin placerat, lacus eu mollis posuere, urna turpis accumsan nibh, ut varius tortor purus a felis. Sed id libero egestas, condimentum diam ut, pharetra mi. Proin id augue eu arcu cursus molestie. Mauris sit amet sapien lacinia, ornare dolor non, placerat ante. Maecenas eu dui in ex hendrerit convallis ullamcorper ac sem. Vestibulum nec felis dapibus, ullamcorper leo ut, suscipit dolor. Vivamus pellentesque convallis sapien, cursus sollicitudin urna ultrices lacinia. Phasellus pharetra nisl ligula, ac finibus lorem lacinia sit amet. Mauris porttitor venenatis magna viverra auctor.
      
      Aenean id ipsum ullamcorper metus porttitor convallis. Proin convallis justo at leo dignissim elementum. Cras ultrices urna leo, in auctor elit vestibulum vel. Morbi rutrum nibh ut odio luctus vestibulum. Praesent tortor neque, lacinia sit amet cursus ut, semper non mi. Sed feugiat magna tellus, a suscipit libero tincidunt sed. Cras at pulvinar risus. Vestibulum ut nunc vitae erat porttitor iaculis vitae quis nibh.</p>
    <h2>Comments</h2>
    <h3>Add Comment</h3>
    <form>
      <label for="name">Name</label>
      <input id="name" type="text">
      <label for="comment">Comment</label>
      <textarea id="comment" rows="5"></textarea>
      <button id="submitComment" type="button">Submit</button>
    </form>
    <button id="refresh"><span class="fas fa-sync-alt"></span> Refresh</button>
    <div id="comments" class="faded"><span class="fas fa-spinner fa-spin"></span> Loading</div>

    <script src="https://kit.fontawesome.com/617f7aefb4.js" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://npmcdn.com/parse/dist/parse.min.js"></script>
    <script type="text/javascript">
      function escapeHTML(html) {
        return html.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
      }

      function incrementViews(types) {
        Parse.Cloud.run('incrementViews', {
          name: document.title,
          types
        }).then((res) => {
          getViewsAndComments();
        });
      }

      async function getViewsAndComments() {
        return new Promise(resolve => {
          Parse.Cloud.run('getViewsAndComments', {
            name: document.title
          }).then((res) => {
            document.getElementById('allViews').innerText = `All Views: ${ res.allViews }`;
            document.getElementById('uniqueViews').innerText = `Unique Views: ${ res.uniqueViews }`;
            document.getElementById('botViews').innerText = `Bot Views: ${ res.botViews }`;
            if (res.comments.length === 0) {
              document.getElementById('comments').innerText = 'There are currently no comments.';
            } else {
              document.getElementById('comments').classList.remove('faded');
              document.getElementById('comments').innerHTML = res.comments.reverse().reduce((acc, value) => {
                return acc + `<div class="comment"><b>${ value.name }</b><p>${ value.comment }</p><small>${ value.time }</small></div>`;
              }, '');
            }

            resolve();
          });
        });
      }

      Parse.initialize("55LsP3jDMhMzJ5k9J3wqpZ8ebMUrGkcgaj17Pfgz","AjXQYFg6wIhUMunRYpGvoRdNsliOZxRYMFG6FsX7"); //PASTE HERE YOUR Back4App APPLICATION ID AND YOUR JavaScript KEY
      Parse.serverURL = 'https://parseapi.back4app.com/'
      
      if (/bot|crawl|spider/i.test(navigator.userAgent)) {
        incrementViews(['all', 'bot']);
      } else if (localStorage.getItem('Post "' + document.title + '" viewed')) {
        incrementViews(['all']);
      } else {
        localStorage.setItem('Post "' + document.title + '" viewed', true);
        incrementViews(['all', 'unique']);
      }

      document.getElementById('submitComment').addEventListener('click', () => {
        const username = document.getElementById('name').value;
        const comment = escapeHTML(document.getElementById('comment').value);

        Parse.Cloud.run('addComment', {
          name: document.title,
          username,
          comment
        }).then((res) => {
          document.getElementById('comment').value = '';

          if (document.getElementById('comments').innerText === 'There are currently no comments.') {
            document.getElementById('comments').classList.remove('faded');
            document.getElementById('comments').innerHTML = `<div class="comment"><b>${ username }</b><p>${ comment }</p><small>${ res.time }</small></div>`;
          } else {
            document.getElementById('comments').innerHTML = `<div class="comment"><b>${ username }</b><p>${ comment }</p><small>${ res.time }</small></div>`
            + document.getElementById('comments').innerHTML;
          }
        });
      });

      const refresh = document.getElementById('refresh');
      refresh.addEventListener('click', () => {
        refresh.innerHTML = '<span class="fas fa-sync-alt fa-spin"></span> Refreshing';
        getViewsAndComments().then(() => {
          refresh.innerHTML = '<span class="fas fa-sync-alt"></span> Refresh';
        });
      });
    </script>
  </body>
</html>
